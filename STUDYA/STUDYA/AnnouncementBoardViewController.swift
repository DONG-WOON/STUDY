//
//  AnnouncementBoardViewController.swift
//  STUDYA
//
//  Created by ÏÑúÎèôÏö¥ on 2022/08/19.
//

import UIKit
import SnapKit


final class AnnouncementBoardViewController: SwitchableViewController {
    // MARK: - Properties
    
    var announcements: [Announcement] = [
//        Announcement(id: nil, studyID: nil, title: "ÌïúÏ§ÑÏßúÎ¶¨ ÌÉÄÏù¥ÌãÄÎ™Ö", content: "ÌïúÏ§ÑÏßúÎ¶¨ Í≥µÏßÄÏÇ¨Ìï≠Ïùò Í≤ΩÏö∞", createdDate: Date()),
//        Announcement(id: nil, studyID: nil,title: "ÌïúÏ§ÑÏßúÎ¶¨ ÌÉÄÏù¥ÌãÄÎ™ÖÏù∏Îç∞ Ï¢Ä Í∏¥Í≤ΩÏö∞Îäî Ïù¥Î†áÍ≤å Î≥¥Ïù¥Í≥† ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ°ú Îì§Ïñ¥Í∞îÏùÑÎïå Ïù¥Îü∞ÏãùÏúºÎ°ú Î≥¥Ïù¥ÎäîÍ≤å ÎßûÎäîÍ±∞ÏßÄ", content: "ÎëêÏ§ÑÏßúÎ¶¨ Í≥µÏßÄÏÇ¨Ìï≠Ïùò Í≤ΩÏö∞Îäî\nÏù¥Î†áÍ≤å Î≥¥Ïù¥ÎäîÍ≤å ÎßûÏßÄ", createdDate: Date()),
//        Announcement(id: nil, studyID: nil,title: "ÌïÄÍ≥µÏßÄ ÌÉÄÏù¥ÌãÄ", content: "ÌïÄÍ≥µÏßÄÍ∞Ä ÎêòÏñ¥ÏûàÍ≥†\n ÌïúÏ§ÑÏù¥ÏÉÅÏù∏Îç∞Îã§Í∞Ä... ÏïÑÎ¨¥Ìäº ÎßéÏùÄ Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Ïì¥Í≤ΩÏö∞ Ïù¥Î†áÍ≤å Î≥¥Ïù∏Îã§.", createdDate: Date(), isPinned: true),
//        Announcement(id: nil, studyID: nil, title: "ÌïúÏ§ÑÏßúÎ¶¨ ÌÉÄÏù¥ÌãÄÎ™Ö", content: "ÌïúÏ§ÑÏßúÎ¶¨ Í≥µÏßÄÏÇ¨Ìï≠Ïùò Í≤ΩÏö∞", createdDate: Date()),
//        Announcement(id: nil, studyID: nil,title: "ÌïúÏ§ÑÏßúÎ¶¨ ÌÉÄÏù¥ÌãÄÎ™ÖÏù∏Îç∞ Ï¢Ä Í∏¥Í≤ΩÏö∞Îäî Ïù¥Î†áÍ≤å", content: "ÎëêÏ§ÑÏßúÎ¶¨ Í≥µÏßÄÏÇ¨Ìï≠Ïùò Í≤ΩÏö∞Îäî\n Ïù¥Î†áÍ≤å Î≥¥Ïù¥ÎäîÍ≤å ÎßûÏßÄ", createdDate: Date()),
//        Announcement(id: nil, studyID: nil,title: "ÌïÄÍ≥µÏßÄ ÌÉÄÏù¥ÌãÄ", content: "ÌïÄÍ≥µÏßÄÍ∞Ä ÎêòÏñ¥ÏûàÍ≥†\n ÌïúÏ§ÑÏù¥ÏÉÅÏù∏Îç∞Îã§Í∞Ä... ÏïÑÎ¨¥Ìäº ÎßéÏùÄ Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Ïì¥Í≤ΩÏö∞ Ïù¥Î†áÍ≤å Î≥¥Ïù∏Îã§.", createdDate: Date()),
//        Announcement(id: nil, studyID: nil, title: "ÌïúÏ§ÑÏßúÎ¶¨ ÌÉÄÏù¥ÌãÄÎ™Ö", content: "ÌïúÏ§ÑÏßúÎ¶¨ Í≥µÏßÄÏÇ¨Ìï≠Ïùò Í≤ΩÏö∞", createdDate: Date()),
//        Announcement(id: nil, studyID: nil,title: "ÌïúÏ§ÑÏßúÎ¶¨ ÌÉÄÏù¥ÌãÄÎ™ÖÏù∏Îç∞ Ï¢Ä Í∏¥Í≤ΩÏö∞Îäî Ïù¥Î†áÍ≤å", content: "ÎëêÏ§ÑÏßúÎ¶¨ Í≥µÏßÄÏÇ¨Ìï≠Ïùò Í≤ΩÏö∞Îäî\n Ïù¥Î†áÍ≤å Î≥¥Ïù¥ÎäîÍ≤å ÎßûÏßÄ", createdDate: Date()),
//        Announcement(id: nil, studyID: nil,title: "ÌïÄÍ≥µÏßÄ ÌÉÄÏù¥ÌãÄ", content: "ÌïÄÍ≥µÏßÄÍ∞Ä ÎêòÏñ¥ÏûàÍ≥†\n ÌïúÏ§ÑÏù¥ÏÉÅÏù∏Îç∞Îã§Í∞Ä... ÏïÑÎ¨¥Ìäº ÎßéÏùÄ Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Ïì¥Í≤ΩÏö∞ Ïù¥Î†áÍ≤å Î≥¥Ïù∏Îã§.", createdDate: Date())
    ]
    
    private lazy var announcementEmptyView: UIView = {
        let view = UIView()
        let announcementEmptyImageView = UIImageView(frame: CGRect(x: 0, y: 0, width: 120, height: 150))
        let announcementEmptyLabel = CustomLabel(title: "Í≥µÏßÄÍ∞Ä ÏóÜÏñ¥Ïöîüò¥", tintColor: .ppsBlack, size: 20, isBold: true)
        
        view.addSubview(announcementEmptyImageView)
        view.addSubview(announcementEmptyLabel)
        
        announcementEmptyImageView.image = UIImage(named: "emptyViewImage")
        
        setConstraints(announcementEmptyImageView, in: view)
        setConstraints(of: announcementEmptyLabel, with: announcementEmptyImageView)
        
        view.isHidden = true
        return view
    }()
    
    private let headerView = UIView(frame: CGRect(origin: .zero, size: CGSize(width: Const.screenWidth, height: 48)))
    private let titleLabel = CustomLabel(title: "Í≥µÏßÄÏÇ¨Ìï≠", tintColor: .ppsBlack, size: 16, isBold: true)
    
    private let announcementBoardTableView = UITableView()
    private lazy var floatingButtonView = PlusButtonWithLabelContainerView(labelText: "Í≥µÏßÄÏ∂îÍ∞Ä")
    
    // MARK: - Life Cycle
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        navigationItem.title = isSwitchOn ? "Í¥ÄÎ¶¨Ïûê Î™®Îìú" : "Ïä§ÌÑ∞Îîî Ïù¥Î¶Ñ"
        titleLabel.text = isSwitchOn ? "Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨" : "Í≥µÏßÄÏÇ¨Ìï≠"
        
        navigationController?.navigationBar.titleTextAttributes = isSwitchOn ? [.foregroundColor: UIColor.white] : [.foregroundColor: UIColor.black]
        
        view.backgroundColor = .systemBackground
        
        configureHeaderView()
        configureTableView()
        configureEmptyView()
        configureNavigationBar()
        
        configureFloatingButton()
    }
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        
        tabBarController?.tabBar.isHidden = true
        checkAnnouncementBoardIsEmpty()
    }
    
    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        
        syncSwitchReverse(isSwitchOn)
    }
    
    // MARK: - Configure
    
    private func configureHeaderView() {
        headerView.addSubview(titleLabel)
        
        titleLabel.snp.makeConstraints { make in
            make.centerY.equalTo(headerView)
            make.leading.equalTo(headerView).inset(30)
        }
    }
    
    private func configureTableView() {
        
        view.addSubview(announcementBoardTableView)
        
        announcementBoardTableView.dataSource = self
        announcementBoardTableView.delegate = self
        
        announcementBoardTableView.register(AnnouncementBoardTableViewCell.self, forCellReuseIdentifier: "AnnouncementBoardTableViewCell")
        announcementBoardTableView.rowHeight = 147
        announcementBoardTableView.separatorStyle = .none
        announcementBoardTableView.backgroundColor = .systemBackground
        announcementBoardTableView.tableHeaderView = headerView
        
        announcementBoardTableView.snp.makeConstraints { make in
            make.edges.equalTo(view.safeAreaLayoutGuide)
        }
    }
    
    private func configureEmptyView() {
        announcementBoardTableView.addSubview(announcementEmptyView)
        
        announcementEmptyView.snp.makeConstraints { make in
            make.top.leading.trailing.bottom.equalTo(view.safeAreaLayoutGuide)
        }
    }
    
    private func configureFloatingButton() {
        
        view.addSubview(floatingButtonView)
        
        floatingButtonView.addTapAction(target: nil, action: #selector(floatingButtonDidTapped))
        
        floatingButtonView.snp.makeConstraints { make in
            make.bottom.trailing.equalTo(view.safeAreaLayoutGuide).inset(30)
            make.width.equalTo(102)
            make.height.equalTo(50)
        }
    }
    
    // MARK: - Actions
    
    override func extraWorkWhenSwitchToggled() {
        
        navigationItem.title = isSwitchOn ? "Í¥ÄÎ¶¨Ïûê Î™®Îìú" : "Ïä§ÌÑ∞Îîî Ïù¥Î¶Ñ"
        titleLabel.text = isSwitchOn ? "Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨" : "Í≥µÏßÄÏÇ¨Ìï≠"

        floatingButtonView.isHidden.toggle()
        
        if announcements.count >= 1 {
            let cells = announcementBoardTableView.cellsForRows(at: 0)
            let announcementBoardTableViewCells = cells.compactMap { cell in
                let cell = cell as? AnnouncementBoardTableViewCell
                return cell
            }
            announcementBoardTableViewCells.forEach { cell in
                cell.editable = isSwitchOn
            }
        }
    }
    
    @objc func floatingButtonDidTapped() {
    
        let creatingAnnouncementVC = AnnouncementViewController(task: .creating)
        creatingAnnouncementVC.isMaster = true
        
        let navigationVC = UINavigationController(rootViewController: creatingAnnouncementVC)
        navigationVC.modalPresentationStyle = .fullScreen
        
        present(navigationVC, animated: true)
    }
    
    private func checkAnnouncementBoardIsEmpty(){
        
        announcementEmptyView.isHidden = announcements.isEmpty ? false :  true
    }
    
    // MARK: - Setting Constraints
    
    private func setConstraints(_ announcementEmptyImageView: UIImageView, in view: UIView) {
        
        announcementEmptyImageView.snp.makeConstraints { make in
            make.width.equalTo(120)
            make.height.equalTo(150)
            make.center.equalTo(view)
        }
    }
    
    private func setConstraints(of announcementEmptyLabel: UILabel, with imageView: UIImageView) {
        
        announcementEmptyLabel.snp.makeConstraints { make in
            make.centerX.equalTo(imageView)
            make.top.equalTo(imageView.snp.bottom).offset(20)
        }
    }
}


// MARK: - UITableViewDataSource

extension AnnouncementBoardViewController: UITableViewDataSource {
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return announcements.count
    }

    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {

        guard let cell = tableView.dequeueReusableCell(withIdentifier: "AnnouncementBoardTableViewCell", for: indexPath) as? AnnouncementBoardTableViewCell else { return UITableViewCell() }
        cell.selectionStyle = .none
        
        //ÏûêÏÇ¨Ïö© Ïù¥Ïäà ÎñÑÎ¨∏Ïóê ÏÑ§Ï†ïÌï¥Ï§å.
        cell.editable = self.isSwitchOn
        
        cell.etcButtonAction = { [unowned self] in
            presentActionSheet(selected: cell, indexPath: indexPath, in: tableView)
        }

        cell.cellAction = { [unowned self] in
            let vc = AnnouncementViewController(task: .viewing)
            vc.announcement = announcements[indexPath.row]
            navigationController?.pushViewController(vc, animated: true)
        }

        cell.announcement = announcements[indexPath.row]
        return cell
    }
    
    func presentActionSheet(selected cell: AnnouncementBoardTableViewCell, indexPath: IndexPath, in tableView: UITableView) {
        let actionSheet = UIAlertController(title: nil, message: nil, preferredStyle: .actionSheet)
        
        let pinAction = UIAlertAction(title: "ÌïÄÍ≥µÏßÄ ÏÑ§Ï†ï", style: .default) { _ in
            guard let cells = tableView.cellsForRows(at: 0) as? [AnnouncementBoardTableViewCell] else { return }
            let pinnedCell = cells.filter { cell in cell.announcement?.isPinned == true }.first
            pinnedCell?.announcement?.isPinned = false
            
            cell.announcement?.isPinned = true
        }
        
        
        let editAction = UIAlertAction(title: "ÏàòÏ†ïÌïòÍ∏∞", style: .default) { [unowned self] _ in
          
            let editingAnnouncementVC = AnnouncementViewController(task: .editing)
            editingAnnouncementVC.isMaster = true
            editingAnnouncementVC.announcement = announcements[indexPath.row]
            
            let navigationVC = UINavigationController(rootViewController: editingAnnouncementVC)
            navigationVC.modalPresentationStyle = .fullScreen
            
            present(navigationVC, animated: true)
        }
        
        let deleteAction = UIAlertAction(title: "ÏÇ≠Ï†úÌïòÍ∏∞", style: .destructive) { _ in
            
            let alertController = UIAlertController(title: "Ïù¥Í≥µÏßÄÎ•º ÏÇ≠Ï†ú Ìï†ÍπåÏöî?", message: "ÏÇ≠Ï†úÌïòÎ©¥ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.", preferredStyle: .alert)
            let okAction = UIAlertAction(title: "ÏÇ≠Ï†ú", style: .destructive) {
                _ in

                self.announcements.remove(at: indexPath.row)
                tableView.deleteRows(at: [indexPath], with: .automatic)
                tableView.reloadData()
            }
            
            let cancelAction = UIAlertAction(title: "Îã´Í∏∞", style: .cancel)
            
            alertController.addAction(okAction)
            alertController.addAction(cancelAction)
            
            self.present(alertController, animated: true)
        }
        
        let cancelAction = UIAlertAction(title: Const.cancel, style: .cancel)

        actionSheet.addAction(pinAction)
        actionSheet.addAction(editAction)
        actionSheet.addAction(deleteAction)
        actionSheet.addAction(cancelAction)
        
        present(actionSheet, animated: true)
    }
}

extension AnnouncementBoardViewController: UITableViewDelegate {
    func tableView(_ tableView: UITableView, heightForHeaderInSection section: Int) -> CGFloat {
        return 48
    }
}
